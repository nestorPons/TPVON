<?php namespace app\views\components\controllers;?>
<component id="ticket">
    <img src="https://yt3.ggpht.com/-3BKTe8YFlbA/AAAAAAAAAAI/AAAAAAAAAAA/ad0jqQ4IkGE/s900-c-k-no-mo-rj-c0xffffff/photo.jpg" alt="Logotipo">
    <p>
        TICKET DE VENTA
      <br><?=CITY?>
      <br>17/10/2017 02:22 a.m.
    </p>
        <?php
            $tblTicket = new Table(['columns'=>['Cant', 'Des', 'Imp']]);
        ?>
    <p>¡GRACIAS POR SU VISITA!
      <br><?=NAME_COMPANY?></p>
      <div id=""></div>
    <?php $btnPrTicket = new ButtonSuccess(['onclick'=>'ticket.print()', 'caption'=>'Imprimir'])?>
    <?php $btnSndTicket = new ButtonSuccess(['onclick'=>'ticket.send()', 'caption'=>'Enviar'])?>
</component>
<style id='ticketStyle'>
    #ticket {
        transform: scale(0.8);
        text-align: center;
    }
    #ticket img{
        max-width: 200px;
    }
    #<?=$tblTicket->id()?>{
        padding: 5px;
    }
    @media print{
        *{
            page-break-after:avoid;
            text-align: center;
        }
        component{
            margin: auto;
        }
        button{
            display: none !important;
        }
        img{
            max-width: 40mm;
        }
        @page{
            /* AKI:: En tintero cambiar el tamaño del papel del ticket*/
            size: 80mm 500px;
        }
        table thead{
            text-decoration: underline;
        }
        table td:last{
            text-align: right;
        }
        .break {
            page-break-after: always;
        }
    }
</style>
<script>
const ticket = {
    table : {
        id: '<?=$tblTicket->id()?>',
        ob: $('#<?=$tblTicket->id()?>')
    },
    print(){
        var printContents = document.getElementById('ticket').innerHTML;
        printContents += '<style>' + document.getElementById('ticketStyle').innerHTML + '</style>'
        w = window.open();
        w.document.write(printContents);
        w.document.close(); // necessary for IE >= 10
        w.focus(); // necessary for IE >= 10
		w.print();
		w.close();
        return true; 
    },
    open(Ticket){
        const $template = $($('#template_' + this.table.id)[0].innerHTML)
        for(i in Ticket.lines){
            let line =  Ticket.lines[i]
            let l = $template.clone()
                        .find('.Cant').text(line.qua).end()
                        .find('.Des').text(line.des).end()
                        .find('.Imp').text(line.amo).end()
            
            this.table.ob.find('tbody').append(l) 
        }   
        let t = $template.clone()
                    .find('.Cant').text().end()
                    .find('.Des').text('TOTAL').end()
                    .find('.Imp').text(Ticket.total())
        this.table.ob.find('tfoot').append(t) 
            


    },
    save(){
        tpv.Ticket.changeToLocaleDate()

        let data = {
            controller: 'tickets',
            action: 'new', 
            data: JSON.stringify(tpv.Ticket)
        }
        app.post(data, function(){
            echo('YATA')
        })
    }
}
</script>