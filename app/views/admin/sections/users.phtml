<?php namespace app\views\components\controllers;?>
<section id="users">
    <?php
    $table = new Table(['columns'=>['id', 'Nombre', 'Tel', 'Email'], 'class'=>'hoverable', 'onclick'=>'users.show(window.event)']);
    $abc = new ListABC($table->id());
    $editUser = new Modal(['body'=> \VIEWS\ADMIN\SECTIONS . 'users/edit.phtml'], false);
    ?>

</section>
<style>
    #users{
        display: grid;
        grid-template-rows: 2; 
    }

    #users #<?=$table->id()?>{
        max-height: 80vh ;
        grid-row: 2;
    }

</style>
<script>
'use strict'
var users = {
    table: 'usuarios',
    buttons: ['add', 'del', 'search'],
    currentId: null, 
    Table: new Table('<?=$table->idEl()?>'),
    Form : new Modal('<?=$editUser->id()?>'),
    $table: $('#<?=$table->id()?>').find('tbody'),
    validation(){
        let f = this.Form.getData(),
            usuarios = app.data.get('usuarios')

        for(i in usuarios) {
            let u = usuarios[i]

            if(!isEmpty(f.dni) && u.dni == f.dni && u.id != f.id) return {success: false, code: 'dni', mens: 'Error dni duplicado'} 
            else if( !isEmpty(f.email) && u.email == f.email && u.id != f.id ) return {success: false, code: 'email', mens: 'Error email duplicado'} 
        }

        return {success: true}
    },
    del(){
        this.Table.delLine(this.currentId)
        this.Form.hide()
    },
    add(){
        let data = {    
            id: -1,
            estado: 1
        }
        this.Form.clear().show(data).setTile('Nuevo usuario')
    },
    save(data){ 
        app.data.set(this.table, data , 'id', data.id)

        if (this.currentId == -1 ) this.Table.addLine(data.id, [data.id, data.nombre, data.tel, data.email])
        else this.Table.updateLine(data.id, [data.id, data.nombre, data.tel, data.email])
        this.Form.hide()
    },
    load(){
        let users  = app.data.get(this.table)
        for( i in users ){
            var user = users[i]
            // Listamos los usuarios activos solamente
            if(user.estado == 1){
                this.Table.addLine(
                    user.id, 
                    [user.id, user.nombre, user.tel, user.email]
                )
                .addClass(user.nombre[0].toLowerCase())
                
            }
        }
    },
    show(e){
        this.currentId = e.path[1].attributes.idline.value
        let data = app.data.get(this.table, 'id', this.currentId)
        this.Form.show(data).setTile('Edicion usuario')
    },
    search(value){
        this.$table.find('tr').hide()
        if(value.indexOf('@') != -1) this.searchBy.email()
        else this.searchBy.name(value)
    },
    searchBy: {
        $table: $('#<?=$table->id()?>').find('tbody'),
        hide(){

        },
        name(value){
           let n =  app.data.get('usuarios','nombre', value, 'estado==1')
           for(let i in n){
               this.$table.find(`[idline='${n[i]}'`).show()
           }
        },
        email(value){
            echo('Buscando por email...')
        }
    }
}
</script>
