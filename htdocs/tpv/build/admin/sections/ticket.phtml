<?php namespace app\controllers\components?><section id="buttonsTicket">
    <h1>Factura simplificada</h1>
    <div class="info">
        <?php new \app\core\Components('m-label' , Array('id'=>'id5e296891991d5_total','label'=>'Total','value'=>'0','color'=>'var(--red-color)')) ;?>
        <?php new \app\core\Components('m-label' , Array('id'=>'id5e296891991d5_return','label'=>'A devolver','value'=>'0','color'=>'var(--main-color)')) ;?>
    </div>
    <?php new \app\core\Components('m-input' , Array('id'=>'id5e296891991d5_pay','label'=>'Pago en efectivo','value'=>'0','onkeyup'=>'app.ticket.change()')) ;?>
    <?php new \app\core\Components('m-checkbox' , Array('id'=>'id5e296891991d5_present','class'=>'isPresent','label'=>'Es regalo','name'=>'control','value'=>'1','onclick'=>'app.ticket.toggle()')) ;?>
    <?php new \app\core\Components('m-input' , Array('id'=>'id5e296891991d5_date','type'=>'date','label'=>'Fecha vencimiento','name'=>'fecha_vencimiento')) ;?><br>

    <?php
    $btnPrTicket    = new ButtonSuccess(['onclick' => 'app.ticket.print()', 'caption' => 'Imprimir']);
    $btnSndTicket   = new ButtonSuccess(['onclick' => '', 'caption' => 'Enviar']);
    ?>
    <style lang="less" >
        #buttonsTicket{padding:10px}#buttonsTicket .info{text-align:center;margin:10px 0}#buttonsTicket .info>*{margin:10px}#buttonsTicket .isPresent{margin:10px}
    </style>
</section>
<section id="ticket" class="hidden">
    <img src="/tpv/companies/logo.png" alt="Logotipo">
    <div class="data">
        <div>TICKET DE VENTA</div>
        <hr>
        <div><span id="ticket_nombre_empresa"></span></div>
        <div id="ticket_razon_social">
            <div><span id="ticket_admin"></span></div>
            <div>Dir: <span id="ticket_dir"></span></div>
            <div><span id="ticket_cp"></span> <span id="ticket_poblacion"></span></div>
            <div>Tel: <span id="ticket_tel"></span> NIF: <span id="ticket_nif"></span></div>
            <br>
            <div>Factura Simplificada Nº: <span id="idFra"></span></div>
            <div>Fecha: <span id="dateTicket"></span></div>
        </div>
        <hr>
    </div>
    <?php
    $table = new Table(['columns' => ['Unidad', 'Servicio', 'DTO%', 'Importe'], 'total' => 'true']);
    ?>
    <br>
    <p>
        <hr>
        <div><span id="ticket_iva"></span>% de iva incluído</div>
        <div>¡GRACIAS POR SU VISITA!</div>
    </p>
    <style id='ticketStyle'>
        #ticket {
            transform: scale(0.8);
            overflow: auto;
        }
        
        #ticket * {
            padding: 0;
        }
        
        #ticket_razon_social * {
            text-align: left !important;
        }
        
        #buttonsTicket {
            margin: 1rem 0;
        }
        
        #ticket .data {
            margin: 5px auto;
        }

        #ticket img {
            max-width: 200px;
            height: 200px;
            width: 200px;
        }
        
        #<?= $table->id() ?> {
            padding: 5px;
        }
        
        @media print {
            * {
                page-break-after: avoid;
                text-align: center;
            }
            
            component {
                margin: 0;
                padding: 0;
            }
            
            button {
                display: none !important;
            }
            
            img {
                max-width: 160mm;
                margin: 10px;
            }
            
            @page {
                margin: 0;
                size: 80mm 110mm;
            }
            
            table thead {
                text-decoration: underline;
                border-bottom: 1px solid black;
            }
            
            table td:first {
                border-top: 1px solid black;
            }
            
            .break {
                page-break-after: always;
            }
            
            table {
                margin-bottom: 10px;
        }
        
        table tfoot tr {
            position: absolute;
            left: 170px;
        }
        
        table tfoot td {
            font-weight: bold;
            font-size: 1.2rem;
        }
    }
    </style>
</section>
<script>
    app.ticket = {
        name: 'Tickets',
        Ticket: null,
        present: new MyCheckbox('id5e296891991d5_present'),
        txtExpire: document.getElementById('id5e296891991d5_date'),
        lbltotal: new MyLabel('id5e296891991d5_total'),
        lblreturn: new MyLabel('id5e296891991d5_return'),
        inputpay : new MyInput('id5e296891991d5_pay'), 
        change(){
            let a = parseFloat(this.inputpay.value()), 
                b = parseFloat(this.lbltotal.value()),
                r = a - b; 
echo(
    a , 
    b, 
    r
)
            this.lblreturn.value(r.toFixed(2));     
        },
        frm: {
            nombre: document.getElementById('ticket_nombre_empresa'),
            admin: document.getElementById('ticket_admin'),
            dir: document.getElementById('ticket_dir'),
            cp: document.getElementById('ticket_cp'),
            poblacion: document.getElementById('ticket_poblacion'),
            tel: document.getElementById('ticket_tel'),
            nif: document.getElementById('ticket_nif'),
            iva: document.getElementById('ticket_iva'),
            change: document.getElementById('id5e296891991d5_return_input'),
        },
        Table: new Table('<?= $table->id() ?>'),
        print(callback) {
            this.put(false, _ => {
                imprimirElemento(
                    document.getElementById('ticket'),
                    document.getElementById('ticketStyle')
                );

                typeof callback === 'function' && callback();
            })
        },
        open(Ticket) {
            // Añadimos el total a la casilla total
            this.lbltotal.value(Ticket.total);

            // Ocultamos campo fecha de vencimiento
            this.toggle();
            const
                p1 = DB.get('empresa').then(d => d[0]),
                p2 = DB.get('usuarios', 'nivel', 2).then(d => d[0]),
                p3 = DB.get('config').then(d => d[0]);

            Promise.all([p1, p2, p3]).then(d => {
                    const e = d[0],
                        u = d[1],
                        c = d[2];

                    // Cargamos los datos de la empresa
                    this.frm.nombre.innerHTML = e.nombre;
                    this.frm.admin.innerHTML = u.nombre;
                    this.frm.dir.innerHTML = `${e.calle} ${e.numero}`;
                    this.frm.cp.innerHTML = e.CP;
                    this.frm.poblacion.innerHTML = e.poblacion;
                    this.frm.tel.innerHTML = e.telefono;
                    this.frm.nif.innerHTML = e.nif;
                    this.frm.iva.innerHTML = c.iva;
                    return c.dias;
                })
                .then(async dias => {
                    // Añadimos una fecha standar a la casilla
                    this.txtExpire.value = date.add(app.tpv.date.value, dias, 'days', 'sql');

                    // Reseteamos valor de la casilla regalo
                    this.present.checked(false);
                    this.Table.clear();

                    this.Ticket = Ticket;

                    let numFra = this.Ticket.fecha.getFullYear().toString().substr(2);
                    numFra += '/' + this.Ticket.id.toString().padStart(6, 0);
                    $('#ticket')
                        .find('#dateTicket').text(Ticket.fecha.toLocaleString()).end()
                        .find('#idFra').text(numFra).end();

                    for (let i in Ticket.lines) {
                        const line = Ticket.lines[i],
                            a = await DB.get('servicios', 'id', line.articulo),
                            nombre = a ? a[0] : 'No encontrado';

                        this.Table.addLine(line.id, [line.cantidad, nombre, line.dto, `${line.amo}€`]);
                    }
                    this.Table.total(this.Ticket.setTotal());
                });
        },
        async put(sendMail = false, callback) {
            if (this.Ticket.new) {
                this.Ticket.fecha = date.now('sql');
                this.Ticket.estado = 1;
                this.Ticket.regalo = this.present.checked() ? 1 : 0;
                this.Ticket.fecha_vencimiento = this.txtExpire.value;
                // Guardamos los datos 
                let data = await DB.post('tickets', 'new', this.Ticket.sendData());
                this.lastId = this.Ticket.id = data.id;

                if (this.Ticket.regalo && typeof app.control != 'undefined') app.control.add(this.Ticket);
                app.tpv.add();
            }

            typeof callback === 'function' && callback();
        },
        toggle(e) {
            this.txtExpire.classList.toggle('hidden');
        }
    }
</script>