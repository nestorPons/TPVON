<?php namespace app\controllers\components?><component id="buttonsTicket">
    <?php 
    $btnPrTicket = new ButtonSuccess(['onclick'=>'app.ticket.print()', 'caption'=>'Imprimir']);
    $btnSndTicket = new ButtonSuccess(['onclick'=>'app.ticket.send()', 'caption'=>'Enviar']);
    $present = new Checkbox(['label' => 'Regalo', 'name'=>'control', 'value'=>1]);
    ?>
</component>
<component id="ticket" class="hidden">
    <img src="<?=$Data->pathLogo?>" alt="Logotipo">
    <div class="data">
        <div>TICKET DE VENTA <span id="ticket_nombre_empresa"></span></div>
        <div><span id="ticket_admin"></span></div>
        <div>Dir: <span id="ticket_dir"></span></div>
        <div><span id="ticket_cp"></span> <span id="ticket_poblacion"></span></div>
        <div>Tel: <span id="ticket_tel"></span> NIF: <span id="ticket_nif"></span></div>
        <br>
        <div>N Fac: <span id="idFra"></span></div>
        <div>Fecha: <span id="dateTicket"></span></div>
    </div>
        <?php
            $tblTicket = new Table(['columns'=>['Cant', 'Des', 'Imp']]);
        ?>
    <p>
        <div>Iva incluído</div>
        <div>¡GRACIAS POR SU VISITA!</div>
    </p>
</component>
<style id='ticketStyle'>
    #ticket {
        transform: scale(0.8);
        text-align: center;
        overflow: auto;
    }
    #buttonsTicket{
        margin: 1rem 0;
    }
    #ticket .data{
        margin: 5px auto; 
    }
    #ticket img{
        max-width: 200px;
    }
    #<?=$tblTicket->id()?>{
        padding: 5px;
    }
    #ticket .footer td{
        font-weight: bold;
        font-size: 1.2rem;
    }
    @media print{
        *{
            page-break-after:avoid;
            text-align: center;
        }
        component{
            margin: 0;
            padding: 0;
        }
        button{
            display: none !important;
        }
        img{
            max-width: 60mm;
            margin: 10px;
        }
        @page{
            /* AKI:: En tintero cambiar el tamaño del papel del ticket*/
            size: 80mm 190mm;
        }
        table thead{
            text-decoration: underline;
            border-bottom: 1px solid black;
        }
        table td:first{
            border-top: 1px solid black;
        }
        table td:last{
            text-align: right;
        }
        .break {
            page-break-after: always;
        }
        table .footer td{
            font-weight: bold;
            font-size: 1.2rem;
        }
    }
</style>
<script>
    app.ticket = {
        Ticket      : null, 
        present     : document.getElementById('<?=$present->idEl()?>'), 
        frm    : {
            nombre      : document.getElementById('ticket_nombre_empresa'), 
            admin       : document.getElementById('ticket_admin'),
            dir         : document.getElementById('ticket_dir'),
            cp          : document.getElementById('ticket_cp'),
            poblacion   : document.getElementById('ticket_poblacion'),
            tel         : document.getElementById('ticket_tel'),
            nif         : document.getElementById('ticket_nif'),
        },
        table   : {
            id  : '<?=$tblTicket->id()?>',
            ob  : $('#<?=$tblTicket->id()?>')
        },
        print(callback){

            this.put(false, fn => {

                let printContents = document.getElementById('ticket').innerHTML
                printContents
                printContents += '<style>' + document.getElementById('ticketStyle').innerHTML + '</style>'

                let w = window.open();
                w.document.write(printContents);
                w.document.close(); // necessary for IE >= 10
                w.focus(); // necessary for IE >= 10
                w.print();
                w.close();
                
                typeof callback == 'function' && callback()
            })
        },
        open(Ticket){
            DB.get('empresa').then(d => d[0])
            .then(d => {
                // Cargamos los datos de la empresa
                this.frm.nombre.value      = d.nombre
                this.frm.admin.value       = 'ANONIM',
                this.frm.dir.value         = `${d.calle} ${d.numero}`,
                this.frm.cp.value          = d.CP,
                this.frm.poblacion.value   = d.poblacion,
                this.frm.tel.value         = d.telefono,
                this.frm.nif.value         = d.nif 
            })

            // Reseteamos valor de la casilla regalo
            this.present.checked = 0
            this.Ticket = Ticket
            const $template = $($('#template_' + this.table.id)[0].innerHTML)
            let numFra = this.Ticket.fecha.getFullYear().toString().substr(2) 
            numFra += '/' + this.Ticket.id.toString().padStart(6,0)
            $('#ticket')
                .find('#dateTicket').text(Ticket.fecha.toLocaleString()).end()
                .find('#idFra').text(numFra).end()
            for(i in Ticket.lines){
                let line =  Ticket.lines[i]
                let l = $template.clone()
                        .find('.Cant').text(line.cantidad).end()
                        .find('.Des').text(line.des).end()
                        .find('.Imp').text(line.amo).end()
                
                this.table.ob.find('tbody').append(l) 
            }   
            let t = $template.clone()
                .addClass('footer')
                .find('.Cant').text('').end()
                .find('.Des').text('TOTAL').end()
                .find('.Imp').text(Ticket.total()).end()
            this.table.ob.find('tbody').append(t) 
        },
        put(sendMail = false, callback){
            this.Ticket.fecha = new Date().toISOString().slice(0,16).replace('T',' ')
            this.Ticket.estado = 1
            this.Ticket.regalo = this.present.checked | 0 
            if(this.Ticket.regalo != 0 && typeof app.control != 'undefined') app.control.load() 
            let data = {
                controller: 'tickets',
                action: 'new', 
                data: this.Ticket
            }
            app.post(data, (data, r) => {
                if(r){
                    this.lastId = this.Ticket.id = data.id
                    if(this.Ticket.regalo && typeof app.control != 'undefined') app.control.add(this.Ticket)
                    app.tpv.add()
                }
                callback()
             })
        }
    }
</script>