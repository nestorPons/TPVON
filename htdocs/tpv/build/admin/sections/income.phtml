<?php namespace app\controllers\components?><section id="income">
<?php 
    $from       = new DatePicker(['label'=>'De', 'tabindex' => 1]);
    $to         = new DatePicker(['label'=>'Hasta', 'tabindex' => 2]);
    $seluser    = new Select(['label' => 'Usuario', 'tabindex' => 3]);
    $total      = new InputRead(['label' => 'Total', 'iconlast' => '', 'class'=>'text-right']);
    $table      = new Table(['columns'=>['Ticket', 'Fecha', 'Hora', 'Servicio', 'Precio', 'Cantidad', 'DTO', 'Importe']]);
?>
</section>
<style lang="less">#income{align-items:flex-start;display:grid;grid-template-rows:auto auto 1fr auto;grid-template-columns:repeat(3,1fr);grid-row-gap:5px}#income table{grid-row:2;grid-column:1 / span 3}#income table *{padding:2px}#income .Importe{text-align:right}#income #<?=$total->id()?>{grid-column:3}</style>
<script>
    app.income = {
        buttons     : ['print', 'filter'],
        txtFrom     : <?=$from->id()?>, 
        txtTo       : <?=$to->id()?>, 
        txtTotal    : <?=$total->idEl()?>,
        SelUser  :  new Select('<?=$seluser->id()?>'),
        table       : <?=$table->id()?>, 
        Table       : new Table('<?=$table->id()?>'),
        load(){
            this.loadUsers()
            this.filter()
        },
        loadUsers(){
            let el = this.SelUser
            el.clear()

            DB
            .get('usuarios','estado', 1)
            .then(users => {
                for(let u of users){
                    el.addOption(u.id, u.nombre)
                }
            })
        },
        filter(){
            this.Table.clear()
            data = {
                controller: 'tickets',
                action: 'getBetween',
                data:{
                    f1 : app.date.format(this.txtFrom.value, 'sql'),
                    f2 : app.date.format(this.txtTo.value, 'sql'),
                    u  : this.SelUser.value()
                }
            }
            app.post(data, data => {
                let t = 0
                for(let i in data){
                    let d = data[i]
                    for(let x in d.lineas){
                        let l = d.lineas[x]
                        if(d.estado == 1) this.Table.addLine( null , 
                            [
                                d.id, 
                                app.date.format(d.fecha, 'print'), 
                                app.date.format(d.fecha, 'hour'),
                                l.articulo, 
                                l.precio, 
                                l.cantidad, 
                                l.dto, 
                                l.importe
                            ])
                    }
                    t += d.total
                    
                }
                this.txtTotal.value = t.toFixed(2)

            } )
        },
        print(){

            let printContents = 
                `<h1> Listado de ingresos </h1>
                <h2> Fecha inicio : ${this.txtFrom.value}</h2>
                <h2> Fecha fin : ${this.txtTo.value}</h2>

                <table> ${this.table.innerHTML} </table>
                <h4>Total: <b>${this.txtTotal.value}</b></h4>`

            //printContents += '<style>' + document.getElementById('incomeStyle').innerHTML + '</style>'
            w = window.open();
            w.document.write(printContents);
            w.document.close(); // necessary for IE >= 10
            w.focus(); // necessary for IE >= 10
            w.print();
            w.close(); 
            
        },
    }
</script>